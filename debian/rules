#!/usr/bin/make -f
# -*- makefile -*-
# debian/rules for paper

export DH_OPTIONS=

include /usr/share/dpkg/architecture.mk

package	:= $(firstword $(shell dh_listpackages))
prefix	:= $(CURDIR)/debian/tmp
share	:= /usr/share

config_flags	:= --prefix=/usr \
	--sysconfdir=/etc \
	--libexecdir=\$${prefix}/lib/$(DEB_HOST_MULTIARCH)
	--mandir=$(share)/man \
	--build=$(DEB_BUILD_GNU_TYPE)
ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
cross_config_flags	:=
else
cross_config_flags	:= --host=$(DEB_HOST_GNU_TYPE)
endif

cflags	:= -g -Wall
ifeq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
cflags	+= -O2
else
cflags	+= -O0
endif

export CFLAGS=$(cflags)

version	:= $(shell dpkg-parsechangelog | \
			sed -ne 's/^Version: *\([0-9]\+:\)*//p')

get_misc_file		= ln -sf /usr/share/misc/$(1) . || true
update_config_sub       := $(call get_misc_file,config.sub)
update_config_guess     := $(call get_misc_file,config.guess)

tag:
	cvs tag -c -F $(subst .,_,debian_version_$(version))
ifeq ($(findstring -,$(version)),)
	cvs tag -c -F $(subst .,_,upstream_version_$(version))
endif

config:	config-stamp
config-stamp:
	dh_testdir
	dh_autoreconf
	$(update_config_sub)
	$(update_config_guess)
	mkdir -p debian/build
	cd debian/build && \
		$(SHELL) ../../configure $(config_flags) $(cross_config_flags)
ifneq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))
	mkdir -p debian/build-native
	cd debian/build-native && $(SHELL) ../../configure $(config_flags)
endif
	touch $@

build:	config build-stamp
build-stamp:
	$(MAKE) -C debian/build
ifneq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))
	$(MAKE) -C debian/build-native
endif
	touch $@

clean:	checkroot
	rm -f *-stamp
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -rf debian/build debian/build-native
	dh_clean

binary-indep:	DH_OPTIONS=-i
binary-indep:	checkroot build
	dh_prep
	dh_installdirs

	$(MAKE) -C debian/build install DESTDIR=$(prefix)

	dh_install
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary-arch:	DH_OPTIONS=-a
binary-arch:	checkroot build
	dh_prep
	dh_installdirs

	$(MAKE) -C debian/build install DESTDIR=$(prefix)

	dh_install

	dh_installchangelogs
	dh_installdocs

	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch

.PHONY:	binary binary-indep binary-arch clean checkroot build config tag
